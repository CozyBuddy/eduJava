package days03;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.Map.Entry;
import java.util.Set;

import com.util.DBConn;

import domain.DeptcVO;
import domain.EmpcVO;

public class Review {
	public static void main(String[] args) {
		String sql = "select d.deptno , count(*) from dept d right join emp e on e.deptno = d.deptno group by d.deptno";
		String esql = "select d.deptno,empno,ename,hiredate,sal from emp e ,dept d where e.deptno = ? ";
		
		PreparedStatement pst = null;
		PreparedStatement pst2 = null;
		ResultSet rs = null;
		ResultSet rs2 = null;
		Connection conn = null ;
		ArrayList<EmpcVO> al = null;
		LinkedHashMap<DeptcVO, ArrayList<EmpcVO>> lhm = new LinkedHashMap<DeptcVO, ArrayList<EmpcVO>>();
		EmpcVO ev = null;
		DeptcVO dv= null;
		
		conn = DBConn.getConnection();
		try {
			
				pst = conn.prepareStatement(sql);
				rs = pst.executeQuery();
			if (rs.next()) {
				do {
				 int deptno =rs.getInt("deptno");
				 dv = new DeptcVO(deptno, rs.getInt("count(*)"));
				 pst2 = conn.prepareStatement(esql);
				 pst2.setInt(1, deptno );
				 rs2 = pst.executeQuery();
				 if (rs2.next()) {
					 	al = new ArrayList<EmpcVO>();
					 do {
						 	
							ev = new EmpcVO(rs2.getInt("deptno"),rs2.getInt("empno"),rs2.getString("ename"),(java.sql.date)rs2.getDate("hiredate"),rs2.getInt("sal"));
							
							al.add(ev);
					 } while (rs2.next());
				
				}
				
				 lhm.put(dv, al);
				 pst2.close();
				 rs2.close();
				
			  } while (rs.next());
				
		 }
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} finally {
			try {
				rs.close();
				pst.close();
				DBConn.close();
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			
		}
		displhm(lhm);
		
		
	}

	private static void displhm(LinkedHashMap<DeptcVO, ArrayList<EmpcVO>> lhm) {
		Set<Entry<DeptcVO, ArrayList<EmpcVO>>> st = lhm.entrySet();
		Iterator<Entry<DeptcVO, ArrayList<EmpcVO>>> ir = st.iterator();
		while (ir.hasNext()) {
			Entry<DeptcVO, ArrayList<EmpcVO>> ey =  ir.next();
			DeptcVO dv = ey.getKey();
			ArrayList<EmpcVO> al2 = ey.getValue();
			System.out.println("부서번호 :" + dv.getDeptno() + "인원수 :"+ dv.getCount());
			
			Iterator<EmpcVO> ir2 = al2.iterator();
			while (ir2.hasNext()) {
				EmpcVO empcVO =  ir2.next();
				System.out.print( "EMPNO : " + empcVO.getEmpno() + "사원이름 : " + empcVO.getEname() +"사원고용일자 :"+ empcVO.getHiredate() +"급여 : "+ empcVO.getSal());
				
			}
			
			
			
		}
		
	}

}
